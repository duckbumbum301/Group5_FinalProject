<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>X·ª≠ l√Ω thanh to√°n VNPay - V·ª±a Vui V·∫ª</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }

      .container {
        background: white;
        padding: 60px 40px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 480px;
        width: 90%;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 30px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      h2 {
        color: #333;
        margin: 0 0 16px;
        font-size: 24px;
        font-weight: 600;
      }

      p {
        color: #666;
        margin: 0 0 20px;
        font-size: 16px;
        line-height: 1.6;
      }

      .success {
        color: #10b981;
      }

      .error {
        color: #ef4444;
      }

      .order-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        text-align: left;
      }

      .order-info div {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
      }

      .order-info div:last-child {
        border-bottom: none;
        font-weight: 600;
        color: #667eea;
      }

      .btn {
        display: inline-block;
        padding: 12px 32px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        margin-top: 20px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #5568d3;
      }

      .message {
        display: none;
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: block;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Loading State -->
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <h2>ƒêang x·ª≠ l√Ω thanh to√°n...</h2>
        <p>Vui l√≤ng ch·ªù trong gi√¢y l√°t, ƒë·ª´ng t·∫Øt trang n√†y.</p>
      </div>

      <!-- Success State -->
      <div id="successState" class="message">
        <svg
          width="80"
          height="80"
          viewBox="0 0 80 80"
          fill="none"
          style="margin: 0 auto 20px"
        >
          <circle
            cx="40"
            cy="40"
            r="38"
            stroke="#10b981"
            stroke-width="4"
            fill="none"
          />
          <path
            d="M25 40L35 50L55 30"
            stroke="#10b981"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <h2 class="success">‚úÖ Thanh to√°n th√†nh c√¥ng!</h2>
        <p>ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n v√† s·∫Ω s·ªõm ƒë∆∞·ª£c giao ƒë·∫øn.</p>
        <div id="orderInfo" class="order-info"></div>
        <a href="./index.html" class="btn">V·ªÅ trang ch·ªß</a>
      </div>

      <!-- Error State -->
      <div id="errorState" class="message">
        <svg
          width="80"
          height="80"
          viewBox="0 0 80 80"
          fill="none"
          style="margin: 0 auto 20px"
        >
          <circle
            cx="40"
            cy="40"
            r="38"
            stroke="#ef4444"
            stroke-width="4"
            fill="none"
          />
          <path
            d="M30 30L50 50M50 30L30 50"
            stroke="#ef4444"
            stroke-width="4"
            stroke-linecap="round"
          />
        </svg>
        <h2 class="error">‚ùå Thanh to√°n kh√¥ng th√†nh c√¥ng</h2>
        <p id="errorMessage">Giao d·ªãch ƒë√£ b·ªã h·ªßy ho·∫∑c x·∫£y ra l·ªói.</p>
        <div id="errorDetails" class="order-info"></div>
        <a href="./index.html" class="btn">V·ªÅ trang ch·ªß</a>
      </div>
    </div>

    <script type="module">
      import { parseVNPayReturn } from "../js/vnpay-api.js";
      import { apiMarkOrderPaid, apiGetOrderById } from "../js/api.js";

      let processed = false;
      const loadingState = document.getElementById("loadingState");
      const successState = document.getElementById("successState");
      const errorState = document.getElementById("errorState");
      const orderInfo = document.getElementById("orderInfo");
      const errorDetails = document.getElementById("errorDetails");
      const errorMessage = document.getElementById("errorMessage");

      async function processVNPayReturn() {
        if (processed) return;
        processed = true;

        try {
          // Parse VNPay response
          const vnpayData = parseVNPayReturn();
          console.log("üì• VNPay Response:", vnpayData);

          const {
            responseCode,
            txnRef,
            amount,
            transactionNo,
            isSuccess,
            message,
          } = vnpayData;
          const orderId = txnRef || localStorage.getItem("vvv_pending_order");

          if (!orderId) {
            throw new Error("Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng");
          }

          // Hi·ªÉn th·ªã th√¥ng tin
          const displayAmount = amount ? parseInt(amount) / 100 : 0;

          if (isSuccess && responseCode === "00") {
            // ‚úÖ THANH TO√ÅN TH√ÄNH C√îNG
            try {
              // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
              await apiMarkOrderPaid(orderId);

              // L·∫•y th√¥ng tin ƒë∆°n h√†ng
              const order = await apiGetOrderById(orderId);

              // Hi·ªÉn th·ªã th√¥ng tin
              orderInfo.innerHTML = `
              <div>
                <span>M√£ ƒë∆°n h√†ng:</span>
                <strong>#${orderId}</strong>
              </div>
              <div>
                <span>S·ªë ti·ªÅn:</span>
                <strong>${displayAmount.toLocaleString("vi-VN")}‚Ç´</strong>
              </div>
              <div>
                <span>M√£ giao d·ªãch:</span>
                <strong>${transactionNo || "N/A"}</strong>
              </div>
              <div>
                <span>Tr·∫°ng th√°i:</span>
                <strong class="success">${message}</strong>
              </div>
            `;

              // Clear pending order
              localStorage.removeItem("vvv_pending_order");
              localStorage.removeItem("vvv_pending_order_time");

              // Show success state
              loadingState.classList.add("hidden");
              successState.classList.add("loading");

              // Dispatch event cho c√°c module kh√°c
              document.dispatchEvent(
                new CustomEvent("order:confirmed", {
                  detail: { orderId, payment: "vnpay" },
                })
              );

              // Auto redirect sau 5 gi√¢y
              setTimeout(() => {
                window.location.href = `./index.html?order_success=${orderId}`;
              }, 5000);
            } catch (error) {
              console.error("Error updating order:", error);
              // V·∫´n hi·ªÉn th·ªã success v√¨ ti·ªÅn ƒë√£ tr·ª´
              orderInfo.innerHTML = `
              <div>
                <span>M√£ ƒë∆°n h√†ng:</span>
                <strong>#${orderId}</strong>
              </div>
              <div>
                <span>S·ªë ti·ªÅn:</span>
                <strong>${displayAmount.toLocaleString("vi-VN")}‚Ç´</strong>
              </div>
              <div>
                <span>L∆∞u √Ω:</span>
                <strong class="error">Vui l√≤ng li√™n h·ªá CSKH ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng</strong>
              </div>
            `;

              loadingState.classList.add("hidden");
              successState.classList.add("loading");

              localStorage.removeItem("vvv_pending_order");
              localStorage.removeItem("vvv_pending_order_time");
            }
          } else {
            // ‚ùå THANH TO√ÅN TH·∫§T B·∫†I
            errorMessage.textContent = message || "Giao d·ªãch kh√¥ng th√†nh c√¥ng";
            errorDetails.innerHTML = `
            <div>
              <span>M√£ ƒë∆°n h√†ng:</span>
              <strong>#${orderId}</strong>
            </div>
            <div>
              <span>M√£ l·ªói:</span>
              <strong>${responseCode}</strong>
            </div>
            <div>
              <span>L√Ω do:</span>
              <strong>${message}</strong>
            </div>
          `;

            loadingState.classList.add("hidden");
            errorState.classList.add("loading");

            // Clear pending
            localStorage.removeItem("vvv_pending_order");
            localStorage.removeItem("vvv_pending_order_time");

            // Auto redirect sau 7 gi√¢y
            setTimeout(() => {
              window.location.href = "./index.html";
            }, 7000);
          }
        } catch (error) {
          console.error("Process VNPay Return Error:", error);
          errorMessage.textContent =
            "C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n";
          errorDetails.innerHTML = `
          <div>
            <span>L·ªói:</span>
            <strong>${error.message}</strong>
          </div>
        `;

          loadingState.classList.add("hidden");
          errorState.classList.add("loading");
        }
      }

      // Auto execute when page loads
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", processVNPayReturn);
      } else {
        processVNPayReturn();
      }

      // Timeout fallback
      setTimeout(() => {
        if (!processed) {
          console.warn("‚è±Ô∏è Timeout processing VNPay return");
          errorMessage.textContent =
            "Timeout x·ª≠ l√Ω thanh to√°n. Vui l√≤ng ki·ªÉm tra email ho·∫∑c li√™n h·ªá CSKH.";
          loadingState.classList.add("hidden");
          errorState.classList.add("loading");
          processed = true;
        }
      }, 30000); // 30 gi√¢y
    </script>
  </body>
</html>
