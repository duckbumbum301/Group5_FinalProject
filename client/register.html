<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ƒêƒÉng k√Ω ‚Äî V·ª±a Vui V·∫ª</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Cache busting + no-cache for go live -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
      /* ===== Verify Box (overlay) ‚Äî d√πng ri√™ng cho register ===== */
      .verify-overlay {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 50;
      }
      .verify-card {
        width: min(420px, 92vw);
        background: linear-gradient(180deg, #0f172af0, #0b1220e0);
        border: 1px solid #233a5a;
        border-radius: 16px;
        box-shadow: 0 18px 60px #00000055, 0 2px 8px #00000066;
        padding: 18px;
      }
      .code-inputs {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin: 12px 0;
      }
      .code-inputs input {
        text-align: center;
        font-size: 18px;
        padding: 10px 0;
        border-radius: 12px;
        border: 1px solid #233a5a;
        background: #0b152b;
        color: #e5f2ff;
      }
      .verify-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .verify-note {
        color: #cbd5e1;
        font-size: 14px;
        margin-top: 6px;
      }
      .dim {
        opacity: 0.6;
      }
      .linklike {
        background: transparent;
        border: 0;
        color: #22c55e;
        cursor: pointer;
        padding: 0 4px;
        font-weight: 700;
      }
      .linklike[disabled] {
        opacity: 0.4;
        cursor: not-allowed;
      }
      @media (max-width: 420px) {
        .verify-card {
          padding: 14px;
        }
        .code-inputs input {
          font-size: 16px;
          padding: 8px 0;
        }
      }
    </style>
  </head>
  <body class="page-center theme-green">
    <div class="container container--wide container--right container--bare">
      <!-- Trang: Register -->
      <style>
        /* Ch·ªâ √°p d·ª•ng cho ti√™u ƒë·ªÅ trang Register */
        @font-face {
          font-family: "Blenda Script";
          src: url("../assets/font/1FTV-blenda-script.otf") format("opentype");
          font-weight: 400;
          font-style: normal;
          font-display: swap;
        }
        .auth-title {
          font-family: "Blenda Script", cursive;
          font-weight: 800;
          font-size: 34px;
          color: #2f7f31; /* fallback n·∫øu kh√¥ng h·ªó tr·ª£ gradient */
          margin: 0;
        }
        @supports (-webkit-background-clip: text) {
          .auth-title {
            background: linear-gradient(180deg, #1f5a27 0%, #66c372 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
          }
        }
      </style>
      <div class="row" style="text-align: center">
        <h1 align="center" class="auth-title">T·∫°o t√†i kho·∫£n</h1>
      </div>

      <!-- Ch·ª©c nƒÉng: Form ƒëƒÉng k√Ω -->
      <form id="formRegister" novalidate>
        <table class="form-table">
          <tr>
            <td><label for="reName">H·ªç v√† t√™n</label></td>
            <td>
              <input
                id="reName"
                name="name"
                autocomplete="name"
                placeholder="Nguy·ªÖn VƒÉn A"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="reDob">Ng√†y sinh</label></td>
            <td>
              <input
                id="reDob"
                name="dob"
                type="date"
                autocomplete="bday"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="reEmail">Email</label></td>
            <td>
              <input
                id="reEmail"
                name="email"
                type="email"
                autocomplete="email"
                placeholder="nguyenvana@example.com"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="rePhone">S·ªë ƒëi·ªán tho·∫°i</label></td>
            <td>
              <input
                id="rePhone"
                name="phone"
                type="tel"
                inputmode="numeric"
                autocomplete="tel"
                placeholder="VD: 0912345678"
                required
              />
            </td>
          </tr>

          <!-- M·∫≠t kh·∫©u + eye -->
          <tr>
            <td><label for="rePass">M·∫≠t kh·∫©u</label></td>
            <td>
              <div class="pw-wrap">
                <input
                  id="rePass"
                  name="password"
                  type="password"
                  minlength="6"
                  autocomplete="new-password"
                  placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"
                  required
                />
                <button
                  type="button"
                  id="toggleRePass"
                  class="pw-toggle"
                  aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"
                >
                  <svg
                    class="icon-eye"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <circle cx="12" cy="12" r="3" fill="currentColor" />
                  </svg>
                  <svg
                    class="icon-eye-off"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <path
                      d="M4 4l16 16"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <!-- Nh·∫≠p l·∫°i m·∫≠t kh·∫©u + eye -->
          <tr>
            <td><label for="rePass2">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label></td>
            <td>
              <div class="pw-wrap">
                <input
                  id="rePass2"
                  name="password2"
                  type="password"
                  minlength="6"
                  autocomplete="new-password"
                  placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                  required
                />
                <button
                  type="button"
                  id="toggleRePass2"
                  class="pw-toggle"
                  aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u"
                >
                  <svg
                    class="icon-eye"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <circle cx="12" cy="12" r="3" fill="currentColor" />
                  </svg>
                  <svg
                    class="icon-eye-off"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <path
                      d="M4 4l16 16"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <p id="regMsg" class="alert" style="display: none"></p>
          <p id="regOk" class="notice" style="display: none"></p>
        </table>
        <div class="nav-actions" aria-label="ƒëi·ªÅu h∆∞·ªõng">
          <a class="btn btn-ghost" href="index.html">Trang ch·ªß</a>
          <a class="btn btn-ghost" href="login.html"
            >ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a
          >
        </div>
        <div class="register-actions">
          <button class="btn btn-primary" type="submit">ƒêƒÉng k√Ω</button>
        </div>
      </form>
    </div>

    <!-- Verify Code Overlay -->
    <div id="verifyOverlay" class="verify-overlay" aria-hidden="true">
      <div
        class="verify-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="verifyTitle"
      >
        <h2 id="verifyTitle" style="text-align: center">X√°c minh email</h2>
        <p class="verify-note" id="verifyInfo">
          Ch√∫ng t√¥i ƒë√£ g·ª≠i m√£ 6 s·ªë t·ªõi email.
        </p>

        <!-- √î nh·∫≠p 6 s·ªë -->
        <div
          class="code-inputs"
          id="codeInputs"
          aria-label="M√£ x√°c minh g·ªìm 6 ch·ªØ s·ªë"
        >
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
        </div>

        <div class="verify-actions">
          <button id="btnConfirmCode" class="btn btn-primary">X√°c nh·∫≠n</button>
          <span class="right"></span>
          <span id="countdown" class="dim">00:60</span>
          <button id="btnResend" class="linklike" disabled>G·ª≠i l·∫°i</button>
        </div>

        <p id="verifyMsg" class="alert" style="display: none"></p>
      </div>
    </div>

    <!-- Core auth d√πng chung -->
    <script src="auth.js?v=flowfix1"></script>
    <script type="module">
      // X√ìA vvv_return_to ngay khi v√†o trang ƒëƒÉng k√Ω ƒë·ªÉ tr√°nh redirect t·ª± ƒë·ªông
      try {
        localStorage.removeItem("vvv_return_to");
      } catch {}

      import { apiRegisterUser } from "../js/api.js?v=flowfix1";
      import { clearCart } from "../js/cart.js?v=flowfix1";
      /* ===========================
         Toggle con m·∫Øt hi·ªán ƒë·∫°i
         =========================== */
      function bindEyeToggle(inputId, btnId) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (!input || !btn) return;
        btn.addEventListener("click", () => {
          const show = input.type === "password";
          input.type = show ? "text" : "password";
          btn.classList.toggle("active", show);
        });
      }
      bindEyeToggle("rePass", "toggleRePass");
      bindEyeToggle("rePass2", "toggleRePass2");

      /* ===========================
         Lu·ªìng ƒëƒÉng k√Ω + x√°c minh email (frontend-only)
         - T·∫°o m√£ 6 s·ªë v√† console.log (m√¥ ph·ªèng g·ª≠i email)
         - ƒê·∫øm ng∆∞·ª£c 60s, g·ª≠i l·∫°i t·ªëi ƒëa 3 l·∫ßn
         - Nh·∫≠p ƒë√∫ng: g·ªçi API ƒëƒÉng k√Ω & chuy·ªÉn login
         =========================== */
      const form = document.getElementById("formRegister");
      const err = document.getElementById("regMsg");
      const ok = document.getElementById("regOk");

      // Tr·∫°ng th√°i verify
      let pendingUser = null;
      let currentCode = null;
      let resendLeft = 3;
      let timerId = null;
      let expireAt = 0;

      function openVerify(email) {
        const ov = document.getElementById("verifyOverlay");
        const boxes = [...document.querySelectorAll("#codeInputs input")];
        ov.style.display = "grid";
        boxes.forEach((b) => (b.value = ""));
        // clear th√¥ng b√°o c≈© n·∫øu c√≥
        const vm = document.getElementById("verifyMsg");
        if (vm) {
          vm.textContent = "";
          vm.style.display = "none";
        }

        // m√£ 6 s·ªë gi·∫£ l·∫≠p
        currentCode = Array.from({ length: 6 }, () =>
          Math.floor(Math.random() * 10)
        ).join("");
        expireAt = Date.now() + 60_000;
        console.log("[VERIFY] Code:", currentCode);
        let left = 60;
        const countdown = document.getElementById("countdown");
        clearInterval(timerId);
        timerId = setInterval(() => {
          left--;
          countdown.textContent = `00:${left.toString().padStart(2, "0")}`;
          if (left <= 0) clearInterval(timerId);
        }, 1000);
        const btnResend = document.getElementById("btnResend");
        btnResend.disabled = resendLeft <= 0;
        document.getElementById(
          "verifyInfo"
        ).textContent = `M√£ ƒë√£ g·ª≠i ƒë·∫øn ${email}.`;
      }
      function closeVerify() {
        const ov = document.getElementById("verifyOverlay");
        ov.style.display = "none";
        clearInterval(timerId);
        const vm = document.getElementById("verifyMsg");
        if (vm) {
          vm.textContent = "";
          vm.style.display = "none";
        }
      }

      // Cho ph√©p click ra ngo√†i ƒë·ªÉ ƒë√≥ng v√† ch·ªânh s·ª≠a l·∫°i email
      document
        .getElementById("verifyOverlay")
        .addEventListener("click", (e) => {
          if (e.target && e.target.id === "verifyOverlay") {
            closeVerify();
            const emailInput = document.getElementById("reEmail");
            if (emailInput) {
              emailInput.focus();
              emailInput.select?.();
            }
          }
        });
      // ESC c≈©ng ƒë√≥ng overlay ƒë·ªÉ s·ª≠a email
      document.addEventListener("keydown", (e) => {
        const ov = document.getElementById("verifyOverlay");
        if (e.key === "Escape" && ov && ov.style.display === "grid") {
          closeVerify();
          const emailInput = document.getElementById("reEmail");
          if (emailInput) {
            emailInput.focus();
            emailInput.select?.();
          }
        }
      });

      // Confirm code
      document
        .getElementById("btnConfirmCode")
        .addEventListener("click", async () => {
          const boxes = [...document.querySelectorAll("#codeInputs input")];
          const val = boxes.map((b) => b.value).join("");
          const vm = document.getElementById("verifyMsg");
          vm.style.display = "none";
          if (val.length !== 6) {
            vm.textContent = "Vui l√≤ng nh·∫≠p ƒë·ªß 6 s·ªë.";
            vm.style.display = "block";
            return;
          }
          if (Date.now() > expireAt) {
            vm.textContent = "M√£ ƒë√£ h·∫øt h·∫°n. H√£y nh·∫•n G·ª≠i l·∫°i.";
            vm.style.display = "block";
            return;
          }
          if (val !== currentCode) {
            vm.textContent = "M√£ kh√¥ng ƒë√∫ng. H√£y th·ª≠ l·∫°i.";
            vm.style.display = "block";
            return;
          }
          // success: g·ªçi API ƒëƒÉng k√Ω -> close -> redirect
          try {
            const res = await apiRegisterUser({
              name: pendingUser.name,
              email: pendingUser.email,
              phone: pendingUser.phone,
              password: pendingUser.password,
              address: "",
            });
            if (!res?.ok) {
              vm.textContent = res?.message || "ƒêƒÉng k√Ω th·∫•t b·∫°i.";
              vm.style.display = "block";
              return;
            }
            // X√ìA session c≈© (n·∫øu c√≥) v√† x√≥a vvv_return_to ƒë·ªÉ tr√°nh redirect t·ª± ƒë·ªông
            try {
              clearSession();
              localStorage.removeItem("vvv_return_to");
            } catch {}
            closeVerify();
            try {
              clearCart();
            } catch {}
            alert("üéâ ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.");
            window.location.href = "login.html";
          } catch (err) {
            vm.textContent = "C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.";
            vm.style.display = "block";
            console.error(err);
          }
        });

      // Resend
      document.getElementById("btnResend").addEventListener("click", () => {
        if (resendLeft <= 0) return;
        resendLeft--;
        openVerify(pendingUser.email);
      });

      // Submit register form
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const f = new FormData(form);
        const name = (f.get("name") || "").toString().trim();
        const dob = (f.get("dob") || "").toString();
        const email = (f.get("email") || "").toString().trim().toLowerCase();
        const phone = normalizePhoneVN(f.get("phone"));
        const pass = (f.get("password") || "").toString();
        const pass2 = (f.get("password2") || "").toString();

        err.style.display = "none";
        ok.style.display = "none";

        if (!name || !dob || !email || !phone || !pass) {
          err.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.";
          err.style.display = "block";
          return;
        }
        if (pass !== pass2) {
          err.textContent = "Hai m·∫≠t kh·∫©u kh√¥ng tr√πng nhau.";
          err.style.display = "block";
          return;
        }
        if (pass.length < 6) {
          err.textContent = "M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±.";
          err.style.display = "block";
          return;
        }
        if (!emailOk(email)) {
          err.textContent = "Email kh√¥ng h·ª£p l·ªá.";
          err.style.display = "block";
          return;
        }
        if (!validVNPhone(phone)) {
          err.textContent = "SƒêT kh√¥ng h·ª£p l·ªá (10 s·ªë, b·∫Øt ƒë·∫ßu 0).";
          err.style.display = "block";
          return;
        }

        pendingUser = { name, dob, email, phone, password: pass };
        openVerify(email);
      });
    </script>
  </body>
</html>
