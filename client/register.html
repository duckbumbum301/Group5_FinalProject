<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Đăng ký — Vựa Vui Vẻ</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Cache busting + no-cache for go live -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
      /* ===== Verify Box (overlay) — dùng riêng cho register ===== */
      .verify-overlay {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 50;
      }
      .verify-card {
        width: min(420px, 92vw);
        background: linear-gradient(180deg, #0f172af0, #0b1220e0);
        border: 1px solid #233a5a;
        border-radius: 16px;
        box-shadow: 0 18px 60px #00000055, 0 2px 8px #00000066;
        padding: 18px;
      }
      .code-inputs {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin: 12px 0;
      }
      .code-inputs input {
        text-align: center;
        font-size: 18px;
        padding: 10px 0;
        border-radius: 12px;
        border: 1px solid #233a5a;
        background: #0b152b;
        color: #e5f2ff;
      }
      .verify-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .verify-note {
        color: #cbd5e1;
        font-size: 14px;
        margin-top: 6px;
      }
      .dim {
        opacity: 0.6;
      }
      .linklike {
        background: transparent;
        border: 0;
        color: #22c55e;
        cursor: pointer;
        padding: 0 4px;
        font-weight: 700;
      }
      .linklike[disabled] {
        opacity: 0.4;
        cursor: not-allowed;
      }
      @media (max-width: 420px) {
        .verify-card {
          padding: 14px;
        }
        .code-inputs input {
          font-size: 16px;
          padding: 8px 0;
        }
      }
    </style>
  </head>
  <body class="page-center theme-green">
    <div class="container container--wide">
      <!-- Trang: Register -->
      <div class="row" style="text-align: center">
        <h1 align="center">Tạo tài khoản</h1>
        <a class="btn btn-ghost right" href="index.html">Trang chủ</a>
        <a class="btn btn-ghost right" href="login.html"
          >Đã có tài khoản? Đăng nhập</a
        >
      </div>

      <!-- Chức năng: Form đăng ký -->
      <form id="formRegister" novalidate>
        <table class="form-table">
          <tr>
            <td><label for="reName">Họ và tên</label></td>
            <td>
              <input
                id="reName"
                name="name"
                autocomplete="name"
                placeholder="Nguyễn Văn A"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="reDob">Ngày sinh</label></td>
            <td><input id="reDob" name="dob" type="date" autocomplete="bday" required /></td>
          </tr>
          <tr>
            <td><label for="reEmail">Email</label></td>
            <td>
              <input
                id="reEmail"
                name="email"
                type="email"
                autocomplete="email"
                placeholder="nguyenvana@example.com"
                required
              />
            </td>
          </tr>
          <tr>
            <td><label for="rePhone">Số điện thoại</label></td>
            <td>
              <input
                id="rePhone"
                name="phone"
                type="tel"
                inputmode="numeric"
                autocomplete="tel"
                placeholder="VD: 0912345678"
                required
              />
            </td>
          </tr>

          <!-- Mật khẩu + eye -->
          <tr>
            <td><label for="rePass">Mật khẩu</label></td>
            <td>
              <div class="pw-wrap">
                <input
                  id="rePass"
                  name="password"
                  type="password"
                  minlength="6"
                  autocomplete="new-password"
                  placeholder="Tối thiểu 6 ký tự"
                  required
                />
                <button
                  type="button"
                  id="toggleRePass"
                  class="pw-toggle"
                  aria-label="Hiện/ẩn mật khẩu"
                >
                  <svg
                    class="icon-eye"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <circle cx="12" cy="12" r="3" fill="currentColor" />
                  </svg>
                  <svg
                    class="icon-eye-off"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <path
                      d="M4 4l16 16"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <!-- Nhập lại mật khẩu + eye -->
          <tr>
            <td><label for="rePass2">Nhập lại mật khẩu</label></td>
            <td>
              <div class="pw-wrap">
                <input
                  id="rePass2"
                  name="password2"
                  type="password"
                  minlength="6"
                  autocomplete="new-password"
                  placeholder="Nhập lại mật khẩu"
                  required
                />
                <button
                  type="button"
                  id="toggleRePass2"
                  class="pw-toggle"
                  aria-label="Hiện/ẩn mật khẩu"
                >
                  <svg
                    class="icon-eye"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <circle cx="12" cy="12" r="3" fill="currentColor" />
                  </svg>
                  <svg
                    class="icon-eye-off"
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    aria-hidden="true"
                  >
                    <path
                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"
                      stroke="currentColor"
                      stroke-width="2"
                      fill="none"
                    />
                    <path
                      d="M4 4l16 16"
                      stroke="currentColor"
                      stroke-width="2"
                    />
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <div class="row" style="text-align: right; margin-top: 10px">
            <button class="btn btn-primary">Đăng ký</button>
          </div>

          <p id="regMsg" class="alert" style="display: none"></p>
          <p id="regOk" class="notice" style="display: none"></p>
        </table>
      </form>
    </div>

    <!-- Verify Code Overlay -->
    <div id="verifyOverlay" class="verify-overlay" aria-hidden="true">
      <div
        class="verify-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="verifyTitle"
      >
        <h2 id="verifyTitle" style="text-align: center">Xác minh email</h2>
        <p class="verify-note" id="verifyInfo">
          Chúng tôi đã gửi mã 6 số tới email.
        </p>

        <!-- Ô nhập 6 số -->
        <div
          class="code-inputs"
          id="codeInputs"
          aria-label="Mã xác minh gồm 6 chữ số"
        >
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
          <input inputmode="numeric" maxlength="1" />
        </div>

        <div class="verify-actions">
          <button id="btnConfirmCode" class="btn btn-primary">Xác nhận</button>
          <span class="right"></span>
          <span id="countdown" class="dim">00:60</span>
          <button id="btnResend" class="linklike" disabled>Gửi lại</button>
        </div>

        <p id="verifyMsg" class="alert" style="display: none"></p>
      </div>
    </div>

    <!-- Core auth dùng chung -->
    <script src="auth.js?v=flowfix1"></script>
    <script type="module">
      import { apiRegisterUser } from "../js/api.js?v=flowfix1";
      /* ===========================
         Toggle con mắt hiện đại
         =========================== */
      function bindEyeToggle(inputId, btnId) {
        const input = document.getElementById(inputId);
        const btn = document.getElementById(btnId);
        if (!input || !btn) return;
        btn.addEventListener("click", () => {
          const show = input.type === "password";
          input.type = show ? "text" : "password";
          btn.classList.toggle("active", show);
        });
      }
      bindEyeToggle("rePass", "toggleRePass");
      bindEyeToggle("rePass2", "toggleRePass2");

      /* ===========================
         Luồng đăng ký + xác minh email (frontend-only)
         - Tạo mã 6 số và console.log (mô phỏng gửi email)
         - Đếm ngược 60s, gửi lại tối đa 3 lần
         - Nhập đúng: gọi API đăng ký & chuyển login
         =========================== */
      const form = document.getElementById("formRegister");
      const err = document.getElementById("regMsg");
      const ok = document.getElementById("regOk");

      // Trạng thái verify
      let pendingUser = null;
      let currentCode = null;
      let resendLeft = 3;
      let timerId = null;
      let expireAt = 0;

      function openVerify(email) {
        const ov = document.getElementById("verifyOverlay");
        const boxes = [...document.querySelectorAll("#codeInputs input")];
        ov.style.display = "grid";
        boxes.forEach((b) => (b.value = ""));

        // mã 6 số giả lập
        currentCode = Array.from({ length: 6 }, () => Math.floor(Math.random() * 10)).join("");
        expireAt = Date.now() + 60_000;
        console.log("[VERIFY] Code:", currentCode);
        let left = 60;
        const countdown = document.getElementById("countdown");
        clearInterval(timerId);
        timerId = setInterval(() => {
          left--;
          countdown.textContent = `00:${left.toString().padStart(2, "0")}`;
          if (left <= 0) clearInterval(timerId);
        }, 1000);
        const btnResend = document.getElementById("btnResend");
        btnResend.disabled = resendLeft <= 0;
        document.getElementById("verifyInfo").textContent = `Mã đã gửi đến ${email}.`;
      }
      function closeVerify() {
        const ov = document.getElementById("verifyOverlay");
        ov.style.display = "none";
        clearInterval(timerId);
      }

      // Confirm code
      document
        .getElementById("btnConfirmCode")
        .addEventListener("click", async () => {
          const boxes = [...document.querySelectorAll("#codeInputs input")];
          const val = boxes.map((b) => b.value).join("");
          const vm = document.getElementById("verifyMsg");
          vm.style.display = "none";
          if (val.length !== 6) {
            vm.textContent = "Vui lòng nhập đủ 6 số.";
            vm.style.display = "block";
            return;
          }
          if (Date.now() > expireAt) {
            vm.textContent = "Mã đã hết hạn. Hãy nhấn Gửi lại.";
            vm.style.display = "block";
            return;
          }
          if (val !== currentCode) {
            vm.textContent = "Mã không đúng. Hãy thử lại.";
            vm.style.display = "block";
            return;
          }
          // success: gọi API đăng ký -> close -> redirect
          try {
            const res = await apiRegisterUser({
              name: pendingUser.name,
              email: pendingUser.email,
              phone: pendingUser.phone,
              password: pendingUser.password,
              address: "",
            });
            if (!res?.ok) {
              vm.textContent = res?.message || "Đăng ký thất bại.";
              vm.style.display = "block";
              return;
            }
            // Thêm dob vào session (phục vụ hiển thị ở profile)
            try {
              const sess = getSession();
              setSession({ ...(sess || {}), dob: pendingUser.dob });
            } catch {}
            closeVerify();
            alert("Xác minh thành công! Đăng ký hoàn tất.");
            go("login.html");
          } catch (err) {
            vm.textContent = "Có lỗi xảy ra. Vui lòng thử lại.";
            vm.style.display = "block";
            console.error(err);
          }
        });

      // Resend
      document.getElementById("btnResend").addEventListener("click", () => {
        if (resendLeft <= 0) return;
        resendLeft--;
        openVerify(pendingUser.email);
      });

      // Submit register form
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const f = new FormData(form);
        const name = (f.get("name") || "").toString().trim();
        const dob = (f.get("dob") || "").toString();
        const email = (f.get("email") || "").toString().trim().toLowerCase();
        const phone = normalizePhoneVN(f.get("phone"));
        const pass = (f.get("password") || "").toString();
        const pass2 = (f.get("password2") || "").toString();

        err.style.display = "none";
        ok.style.display = "none";

        if (!name || !dob || !email || !phone || !pass) {
          err.textContent = "Vui lòng nhập đầy đủ thông tin.";
          err.style.display = "block";
          return;
        }
        if (pass !== pass2) {
          err.textContent = "Hai mật khẩu không trùng nhau.";
          err.style.display = "block";
          return;
        }
        if (pass.length < 6) {
          err.textContent = "Mật khẩu tối thiểu 6 ký tự.";
          err.style.display = "block";
          return;
        }
        if (!emailOk(email)) {
          err.textContent = "Email không hợp lệ.";
          err.style.display = "block";
          return;
        }
        if (!validVNPhone(phone)) {
          err.textContent = "SĐT không hợp lệ (10 số, bắt đầu 0).";
          err.style.display = "block";
          return;
        }

        pendingUser = { name, dob, email, phone, password: pass };
        openVerify(email);
      });
    </script>
  </body>
</html>
