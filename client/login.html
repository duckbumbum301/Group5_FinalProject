<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Đăng nhập — Vựa Vui Vẻ</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Cache busting + no-cache for go live -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body class="page-center theme-green">
    <div class="container container--wide container--right container--bare">
      <!-- Trang: Login -->
      <div class="row">
        <h1 align="center">Đăng nhập</h1>
        <div style="text-align: center; margin-top: 10px">
          <a class="btn btn-ghost right" href="index.html">Trang chủ</a>
          <a class="btn btn-ghost right" href="register.html">Chưa có tài khoản? Đăng ký</a>
        </div>
      </div>
      <p class="muted">
        Nhập <strong>Tài khoản</strong> và <strong>Mật khẩu</strong> để tiếp tục.
      </p>

      <!-- Chức năng: Form đăng nhập -->
    <form id="formLogin" novalidate>
      <table class="form-table">
        <tr>
          <td><label for="liAccount"><strong>Tài khoản</strong></label></td>
          <td>
            <input
              id="liAccount"
              name="account"
              type="text"
              inputmode="text"
              autocomplete="username"
              autofocus
              placeholder="VD: 0912345678 hoặc email@domain.com"
              required
            />
          </td>
        </tr>
        <tr>
          <td><label for="liPass">Mật khẩu</label></td>
          <td>
            <div class="pw-wrap">
              <input
                id="liPass"
                name="password"
                type="password"
                autocomplete="current-password"
                placeholder="••••••••"
                required
              />
            </div>
            <!--  Checkbox hiển thị mật khẩu -->
            <label class="show-pass">
              <input type="checkbox" id="showPassword" /> Hiển thị mật khẩu
            </label>
            <label id="capsHint" class="small muted" style="display:none">Caps Lock đang bật</label>
          </td>
        </tr>
      </table>

      <div class="row" style="text-align: right; margin-top: 10px">
        <button class="btn btn-primary">Đăng nhập</button>
      </div>

      <p id="loginMsg" class="alert" style="display: none"></p>
    </form>


    <!-- Core auth dùng chung -->
    <script src="auth.js?v=flowfix1"></script>
    <script type="module">
      import { apiLoginUser } from "../js/api.js?v=flowfix1";
      import { clearCart } from "../js/cart.js?v=flowfix1";
      /*  Chức năng: Hiển thị / Ẩn mật khẩu bằng checkbox */
      const showBox = document.getElementById("showPassword");
      const passInput = document.getElementById("liPass");

      if (showBox && passInput) {
        showBox.addEventListener("change", () => {
          passInput.type = showBox.checked ? "text" : "password";
        });
      }

      /* Điều hướng: nếu đã đăng nhập -> quay lại trang trước hoặc trang chủ */
      (function(){
        const sess = getSession();
        if (sess) {
          const ret = localStorage.getItem("vvv_return_to");
          if (ret) {
            localStorage.removeItem("vvv_return_to");
            go(ret);
          } else {
            go("../html/index.html");
          }
        }
      })();

      // Prefill tài khoản lần đăng nhập trước + đặt focus hợp lý
      (function(){
        const accountInput = document.getElementById("liAccount");
        try {
          const lastAcc = localStorage.getItem("vvv_last_login_account")
            || localStorage.getItem("vvv_last_login_phone")
            || localStorage.getItem("vvv_last_login_email");
          if (!getSession() && lastAcc && accountInput && !accountInput.value) accountInput.value = lastAcc;
        } catch {}
        if (accountInput && accountInput.value) { passInput?.focus(); } else { accountInput?.focus(); }
      })();

      // Caps Lock hint
      passInput?.addEventListener("keydown", (e)=>{
        const hint = document.getElementById("capsHint");
        if (!hint || !e.getModifierState) return;
        const on = e.getModifierState("CapsLock");
        hint.style.display = on ? "inline" : "none";
      });

      /* Xử lý đăng nhập */
      document.getElementById("formLogin").addEventListener("submit", async (e) => {
        e.preventDefault();
        const f = new FormData(e.target);
        const accountRaw = (f.get("account") || "").toString().trim();
        const pass = (f.get("password") || "").toString();

        const msg = document.getElementById("loginMsg");
        msg.style.display = "none";

        const btn = document.querySelector("#formLogin button[type='submit'], #formLogin .btn.btn-primary");
        const setBusy = (b) => { if (!btn) return; btn.disabled = b; btn.textContent = b ? "Đang đăng nhập…" : (btn.getAttribute("data-prev")||"Đăng nhập"); btn.setAttribute("aria-busy", String(b)); };
        if (btn && !btn.getAttribute("data-prev")) btn.setAttribute("data-prev", btn.textContent||"Đăng nhập");
        setBusy(true);

        const lowerAcc = accountRaw.toLowerCase();
        const isEmail = emailOk(lowerAcc);
        const normalizedPhone = normalizePhoneVN(accountRaw);
        const isPhone = validVNPhone(normalizedPhone);

        if (!isEmail && !isPhone) {
          msg.textContent = "Vui lòng nhập email hợp lệ hoặc SĐT hợp lệ (10 số, bắt đầu 0).";
          msg.style.display = "block";
          setBusy(false);
          return;
        }
        if (!pass) {
          msg.textContent = "Vui lòng nhập mật khẩu.";
          msg.style.display = "block";
          setBusy(false);
          return;
        }

        try {
          // Lưu tài khoản để lần sau autofill
          try {
            localStorage.setItem("vvv_last_login_account", accountRaw);
            if (isPhone) localStorage.setItem("vvv_last_login_phone", normalizedPhone);
            if (isEmail) localStorage.setItem("vvv_last_login_email", lowerAcc);
          } catch {}
          const res = await apiLoginUser({ email: isEmail ? lowerAcc : "", phone: isPhone ? normalizedPhone : "", password: pass });
          if (!res?.ok) {
            msg.textContent = res?.message || "Đăng nhập thất bại.";
            msg.style.display = "block";
            setBusy(false);
            return;
          }
          // API đã set session: xóa giỏ của phiên cũ rồi quay lại
          try {
            clearCart();
          } catch {}
          try {
            const ret = localStorage.getItem("vvv_return_to");
            if (ret) {
              localStorage.removeItem("vvv_return_to");
              go(ret);
            } else {
              go("../html/index.html");
            }
          } catch {
            go("../html/index.html");
          }
        } catch (err) {
          msg.textContent = "Có lỗi xảy ra. Vui lòng thử lại.";
          msg.style.display = "block";
          console.error(err);
          setBusy(false);
        }
      });
    </script>
  </body>
</html>
