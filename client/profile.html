<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>H·ªì s∆° ‚Äî V·ª±a Vui V·∫ª</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Cache busting + no-cache for go live -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <!-- Trang: Profile (gi·ªØ b·ªë c·ª•c b√¨nh th∆∞·ªùng, kh√¥ng cƒÉn gi·ªØa d·ªçc) -->
    <header class="topbar">
      <strong>üë§ H·ªì s∆° kh√°ch h√†ng</strong>
      <span class="right"></span>
      <button id="btnLogout" class="btn btn-danger">ƒêƒÉng xu·∫•t</button>

      <a class="btn btn-ghost" href="../html/index.html">Front Store</a>
    </header>

    <div class="spacer"></div>

    <main class="page">
      <!-- Ch·ª©c nƒÉng: Hi·ªÉn th·ªã th√¥ng tin t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p -->
      <section class="card">
        <h2>Th√¥ng tin t√†i kho·∫£n</h2>
        <div id="profile"></div>
      </section>
      
      <!-- L·ªãch s·ª≠ ƒë∆°n h√†ng -->
      <section class="card" style="margin-top: 16px;">
        <h2>L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>
        <div id="ordersList"></div>
      </section>
    </main>

    <!-- Core auth d√πng chung -->
    <script src="auth.js?v=flowfix1"></script>
    <script>
      /* ƒêi·ªÅu h∆∞·ªõng: n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -> v·ªÅ login */
      const s = getSession();
      if (!s) {
        go("login.html");
      }
      // ƒê√°nh d·∫•u ƒë√£ xem profile ƒë·ªÉ l·∫ßn sau b·∫•m T√†i kho·∫£n s·∫Ω ƒëƒÉng xu·∫•t
      try { localStorage.setItem("vvv_has_seen_profile", "1"); } catch {}

      /* Render b·∫£ng th√¥ng tin */
      const name = s?.name || "(Ch∆∞a ƒë·∫∑t t√™n)";
      const email = s?.email || "";
      const phone = s?.phone || "";
      const dob = s?.dob || "";

      document.getElementById("profile").innerHTML = `
      <table class="table">
        <thead><tr><th>Tr∆∞·ªùng</th><th>Gi√° tr·ªã</th></tr></thead>
        <tbody>
          <tr><td>T√™n</td><td><strong>${name}</strong></td></tr>
          <tr><td>Email</td><td>${email}</td></tr>
          <tr><td>S·ªë ƒëi·ªán tho·∫°i</td><td>${phone}</td></tr>
          <tr><td>Ng√†y sinh</td><td>${dob}</td></tr>
        </tbody>
      </table>
    `;

      /* Ch·ª©c nƒÉng: ƒêƒÉng xu·∫•t */
      document.getElementById("btnLogout").addEventListener("click", () => {
        clearSession();
        go("login.html");
      });
    </script>
    <script type="module">
      import { apiListOrders, apiGetProductById } from '../js/api.js?v=flowfix1';
      import { money } from '../js/utils.js?v=flowfix1';

      const fmtDate = (iso) => {
        try { const d = new Date(iso); return d.toLocaleString('vi-VN'); } catch { return iso; }
      };

      async function renderOrders() {
        const wrap = document.getElementById('ordersList');
        try {
          const data = await apiListOrders();
          if (!data || !data.length) {
            wrap.innerHTML = `<p class="muted">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>`;
            return;
          }
          const cards = await Promise.all(
            data.slice().reverse().map(async (o) => {
              const entries = Object.entries(o.items || {}).filter(([, q]) => q > 0);
              const ids = entries.map(([pid]) => pid);
              const products = await Promise.all(ids.map((id) => apiGetProductById(id)));
              const map = {}; for (const p of products) if (p && p.id) map[p.id] = p;
              const itemsHtml = entries.map(([pid, q]) => {
                const p = map[pid];
                return p ? `‚Ä¢ ${p.name} √ó ${q}` : `‚Ä¢ ${pid} √ó ${q}`;
              }).join('<br>');
              return `
                <div class="order-card">
                  <div class="order-head">
                    <div><strong>M√£ ƒë∆°n:</strong> ${o.id}</div>
                    <div class="muted">${fmtDate(o.created_at)}</div>
                  </div>
                  <div class="muted">Thanh to√°n: ${o.payment || 'COD'} ¬∑ Khung gi·ªù: ${o.slot || '-'}</div>
                  <div class="order-items">${itemsHtml || '(Kh√¥ng c√≥ m·ª•c h√†ng)'}</div>
                  <div style="margin-top:8px;">
                    <span class="muted">T·∫°m t√≠nh:</span> ${money(o.subtotal || 0)} ¬∑ 
                    <span class="muted">Gi·∫£m:</span> ${money(o.discount || 0)} ¬∑ 
                    <span class="muted">Ship:</span> ${money(o.shipping_fee || 0)} ¬∑ 
                    <span class="order-total">T·ªïng: ${money(o.total || 0)}</span>
                  </div>
                </div>`;
            })
          );
          wrap.innerHTML = cards.join('');
        } catch (err) {
          wrap.innerHTML = `<p class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠ ƒë∆°n h√†ng.</p>`;
          console.error(err);
        }
      }

      renderOrders();
    </script>
  </body>
</html>
