<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Test VNPay Stock Deduction</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .test-box {
        border: 2px solid #ddd;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
      }
      button:hover {
        background: #0056b3;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .log {
        font-size: 12px;
        color: #666;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Test VNPay Stock Deduction</h1>

    <div class="test-box">
      <h3>üìã Th√¥ng tin test</h3>
      <p><strong>S·∫£n ph·∫©m:</strong> B√°nh Oreo (ID: 800)</p>
      <p>
        <strong>Stock hi·ªán t·∫°i:</strong>
        <span id="currentStock">Loading...</span>
      </p>
      <p>
        <strong>API Endpoint:</strong> PATCH
        http://localhost:3000/api/orders/:id/paid
      </p>
    </div>

    <div class="test-box">
      <h3>üîß C√°c b∆∞·ªõc test</h3>
      <button onclick="step1()">B∆∞·ªõc 1: T·∫°o ƒë∆°n VNPay (pending)</button>
      <button onclick="step2()">B∆∞·ªõc 2: M√¥ ph·ªèng VNPay success</button>
      <button onclick="step3()">B∆∞·ªõc 3: Ki·ªÉm tra stock</button>
      <button onclick="refreshStock()">üîÑ Refresh Stock</button>
    </div>

    <div id="logs" class="test-box">
      <h3>üìù Console Logs</h3>
      <div id="logContent"></div>
    </div>

    <script type="module">
      const API_BASE = "http://localhost:3000";
      let testOrderId = null;

      function log(message, type = "info") {
        const logDiv = document.getElementById("logContent");
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error" ? "red" : type === "success" ? "green" : "#666";
        logDiv.innerHTML += `<div class="log" style="color: ${color}">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      async function refreshStock() {
        try {
          const response = await fetch(`${API_BASE}/products/800`);
          const product = await response.json();
          document.getElementById("currentStock").textContent = product.stock;
          log(`‚úÖ Stock hi·ªán t·∫°i: ${product.stock}`, "success");
          return product.stock;
        } catch (error) {
          log(`‚ùå L·ªói l·∫•y stock: ${error.message}`, "error");
        }
      }

      window.step1 = async function () {
        log("üîµ B∆∞·ªõc 1: T·∫°o ƒë∆°n h√†ng VNPay (pending)...");

        const currentStock = await refreshStock();

        try {
          const order = {
            customerName: "Test VNPay",
            phone: "0901234567",
            address: "Test Address",
            email: "test@test.com",
            paymentMethod: "VNPAY",
            payment_status: "pending",
            status: "placed",
            delivery_status: "placed",
            items: {
              800: 2, // 2 B√°nh Oreo
            },
            totalAmount: 30000,
            createdAt: new Date().toISOString(),
          };

          log(`üì¶ ƒê∆°n h√†ng: 2x B√°nh Oreo (Stock tr∆∞·ªõc: ${currentStock})`);

          const response = await fetch(`${API_BASE}/orders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(order),
          });

          const result = await response.json();
          testOrderId = result.id;

          log(`‚úÖ ƒê√£ t·∫°o order: ${testOrderId}`, "success");
          log(`‚è≥ VNPay pending - Stock KH√îNG ƒë∆∞·ª£c tr·ª´ ngay`);

          // Ki·ªÉm tra stock
          const newStock = await refreshStock();
          if (newStock === currentStock) {
            log(`‚úÖ ƒê√öNG: Stock v·∫´n l√† ${newStock} (ch∆∞a tr·ª´)`, "success");
          } else {
            log(`‚ùå SAI: Stock ƒë√£ b·ªã tr·ª´ th√†nh ${newStock}!`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      };

      window.step2 = async function () {
        if (!testOrderId) {
          log("‚ùå Ch∆∞a c√≥ order! Ch·∫°y B∆∞·ªõc 1 tr∆∞·ªõc.", "error");
          return;
        }

        log(`üîµ B∆∞·ªõc 2: M√¥ ph·ªèng VNPay thanh to√°n th√†nh c√¥ng...`);

        const stockBefore = await refreshStock();
        log(`üì¶ Stock tr∆∞·ªõc khi thanh to√°n: ${stockBefore}`);

        try {
          // G·ªçi API gi·ªëng nh∆∞ vnpay-return.html
          log(`üåê Calling: PATCH ${API_BASE}/api/orders/${testOrderId}/paid`);

          const response = await fetch(
            `${API_BASE}/api/orders/${testOrderId}/paid`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();
          log(`‚úÖ API response: ${JSON.stringify(result.success)}`, "success");
          log(`üí≥ Order ${testOrderId} ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† PAID`);

          // Ki·ªÉm tra stock sau khi thanh to√°n
          setTimeout(async () => {
            const stockAfter = await refreshStock();
            const deducted = stockBefore - stockAfter;

            if (deducted === 2) {
              log(
                `‚úÖ TH√ÄNH C√îNG: Stock ƒë√£ tr·ª´ ${deducted} (${stockBefore} ‚Üí ${stockAfter})`,
                "success"
              );
            } else if (deducted === 0) {
              log(`‚ùå L·ªñI: Stock KH√îNG b·ªã tr·ª´! V·∫´n l√† ${stockAfter}`, "error");
              log(
                `üîç Ki·ªÉm tra terminal server xem c√≥ log 'üí≥ Processing VNPay payment' kh√¥ng`,
                "error"
              );
            } else {
              log(
                `‚ö†Ô∏è S·ªë l∆∞·ª£ng tr·ª´ kh√¥ng ƒë√∫ng: ${deducted} (mong ƒë·ª£i 2)`,
                "error"
              );
            }
          }, 500);
        } catch (error) {
          log(`‚ùå L·ªói API: ${error.message}`, "error");
        }
      };

      window.step3 = async function () {
        if (!testOrderId) {
          log("‚ùå Ch∆∞a c√≥ order! Ch·∫°y B∆∞·ªõc 1 v√† 2 tr∆∞·ªõc.", "error");
          return;
        }

        log("üîµ B∆∞·ªõc 3: Ki·ªÉm tra k·∫øt qu·∫£ chi ti·∫øt...");

        try {
          // L·∫•y th√¥ng tin order
          const orderRes = await fetch(`${API_BASE}/orders/${testOrderId}`);
          const order = await orderRes.json();

          log(`üìã Order Status:`);
          log(`   - ID: ${order.id}`);
          log(`   - Payment Status: ${order.payment_status}`);
          log(`   - Payment Method: ${order.paymentMethod}`);
          log(`   - Paid At: ${order.paid_at || "N/A"}`);

          // L·∫•y th√¥ng tin s·∫£n ph·∫©m
          const productRes = await fetch(`${API_BASE}/products/800`);
          const product = await productRes.json();

          log(`üì¶ Product Stock:`);
          log(`   - Name: ${product.name}`);
          log(`   - Current Stock: ${product.stock}`);

          if (order.payment_status === "paid" && product.stock < 55) {
            log(`‚úÖ TEST PASS: VNPay ho·∫°t ƒë·ªông ƒë√∫ng!`, "success");
          } else {
            log(`‚ùå TEST FAIL: C√≥ l·ªói trong lu·ªìng VNPay`, "error");
          }
        } catch (error) {
          log(`‚ùå L·ªói: ${error.message}`, "error");
        }
      };

      window.refreshStock = refreshStock;

      // Load stock khi trang load
      refreshStock();
      log("üöÄ S·∫µn s√†ng test VNPay stock deduction");
      log('üëâ Nh·∫•n "B∆∞·ªõc 1" ƒë·ªÉ b·∫Øt ƒë·∫ßu');
    </script>
  </body>
</html>
